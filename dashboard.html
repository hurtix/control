<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Panader칤a</title>
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.1/dist/basecoat.cdn.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<script src="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.1/dist/js/all.min.js" defer></script>

</head>

<body>
  <!-- Header de autenticaci칩n -->
  <div id="auth-header" class="bg-black text-white p-4 mb-8 flex flex-wrap justify-between items-center gap-2">
    <div class="flex items-center flex-wrap gap-2">
      <span class="flex items-center">游녻 <span id="user-info" class="ml-1">Cargando...</span></span>
      <!-- Aqu칤 se insertar치 la notificaci칩n si es necesaria -->
    </div>
    <div>
      <button class="btn-destructive" onclick="logout()">
        Cerrar Sesi칩n
      </button>
    </div>
  </div>

  <h1>Control de Panader칤a</h1>

  <h2>Registrar Pedido</h2>
  <form id="form-pedido">
    <div class="flex justify-start gap-x-8">
    <div class="grid gap-3">
      <label class="label">Fecha Pedido</label>
      <input class="input" type="text" name="fecha_pedido" readonly class="fecha-auto"></label>
      </div>
    <div class="grid gap-3">
      <label class="label">Fecha Requerida</label>
      <input class="input" type="date" name="fecha_requerida" required></label>
    </div>
    </div>
    
    <!-- Campo de empleado oculto que se llenar치 autom치ticamente -->
    <input type="hidden" name="empleado" id="select-empleado-pedido">

    <h3>Productos y Tiendas</h3>
    <div id="productos-tiendas-container">
      <div class="producto-tienda-item">
        <div class="form-row">
          <label>Producto 
            <select class="producto-select select" onchange="actualizarTiendasProducto(this)">
              <option value="">-- Seleccionar producto --</option>
            </select>
          </label>
        </div>
        <div class="tiendas-cantidades" style="display: none;">
          <h4>Cantidades por tienda:</h4>
          <div class="tiendas-grid" id="tiendas-grid-0"></div>
          <button type="button" class="btn-destructive" onclick="removerProductoPedido(this)">Remover Producto</button>
        </div>
      </div>
    </div>

    <button type="button" class="btn-outline" onclick="agregarProductoPedido()">+ Agregar Producto</button>
    <button type="submit" class="btn">Registrar Pedido</button>
    <div class="endpoint">POST /pedidos</div>
  </form>
  <div id="result-pedido" class="result"></div>

  <h2>Registrar Producci칩n</h2>
  <form id="form-produccion">
    <div class="grid gap-3">
      <label class="label">Fecha</label>
      <input class="input" type="text" name="fecha" readonly class="fecha-auto">
      <input type="hidden" name="lote_id" id="input-lote-id" required>
    </div>
    
    <div>
      <h3>Seleccionar Lote</h3>
      <div id="lotes-cards-container" class="lotes-cards-container"></div>
    </div>
    
    <div id="productos-lote-container" style="display: none;">
      <h3>Productos del Lote</h3>
      <div id="productos-lote-lista"></div>
    </div>
    
    <!-- Campo de empleado oculto que se llenar치 autom치ticamente -->
    <input type="hidden" name="empleado" id="select-empleado">
    
    <label>Observaciones <textarea class="textarea" name="observaciones" placeholder="Observaciones adicionales (opcional)"></textarea></label>
    <button type="submit" class="btn">Registrar Producci칩n</button>
    <div class="endpoint">POST /produccion</div>
  </form>
  <div id="result-produccion" class="result"></div>

  <h2>Registrar Despacho</h2>
  <form id="form-despacho">
    <div class="grid gap-3">
      <label class="label">Fecha</label>
      <input class="input" type="text" name="fecha" readonly class="fecha-auto">
      <input type="hidden" name="lote_id" id="input-lote-id-despacho" required>
    </div>
    
    <div>
      <h3>Seleccionar Lote</h3>
      <div id="lotes-despacho-cards-container" class="lotes-cards-container"></div>
    </div>
    
    <div id="distribucion-despacho-container" style="display: none;">
      <h3>Distribuci칩n Autom치tica</h3>
      <p style="color: #666; font-size: 0.9em; margin-bottom: 1em;">
        Las cantidades se distribuir치n autom치ticamente entre las tiendas seg칰n las proporciones del pedido original.
      </p>
      <div id="distribucion-despacho-lista"></div>
    </div>
    
    <!-- Campo de empleado oculto que se llenar치 autom치ticamente -->
    <input type="hidden" name="empleado" id="select-empleado-despacho">
    
    <label>Observaciones <textarea class="textarea" name="observaciones" placeholder="Observaciones adicionales (opcional)"></textarea></label>
    <button class="btn" type="submit">Despachar Autom치ticamente</button>
    <div class="endpoint">POST /despacho (distribuci칩n autom치tica)</div>
  </form>
  <div id="result-despacho" class="result"></div>

  <h2>Registrar Recepci칩n</h2>
  <form id="form-recepcion">
    <div class="grid gap-3">
      <label class="label">Fecha</label>
      <input class="input" type="text" name="fecha" readonly class="fecha-auto">
    </div>
    
    <div class="form-row">
      <label>Lote</label>
      <div id="lotes-recepcion-container" class="card-container">
        <!-- Aqu칤 se mostrar치n los lotes disponibles para recepci칩n -->
        <div class="spinner-container">
          <div class="spinner"></div>
          <p>Cargando lotes...</p>
        </div>
      </div>
      <input type="hidden" name="lote_id" id="lote-recepcion-selected">
    </div>
    
    <div id="tiendas-lote-container" style="display: none;">
      <input type="hidden" name="tienda" id="tienda-usuario-actual">
      <!-- La tienda se detectar치 autom치ticamente seg칰n el usuario -->
    </div>
    
    <div id="despachos-tienda-container" style="display: none;">
      <h3>Items a Recibir por la Tienda</h3>
      <p style="color: #666; font-size: 0.9em; margin-bottom: 1em;">
        Confirme las cantidades recibidas para esta tienda espec칤fica.
      </p>
      <div id="despachos-tienda-lista"></div>
    </div>
    
    <!-- Campo de empleado oculto que se llenar치 autom치ticamente -->
    <input type="hidden" name="empleado" id="select-empleado-recepcion">
    
    <label>Observaciones <textarea class="textarea" name="observaciones" placeholder="Observaciones adicionales (opcional)"></textarea></label>
    <button class="btn" type="submit">Registrar Recepci칩n de Tienda</button>
    <div class="endpoint">POST /recepcion (por tienda individual)</div>
  </form>
  <div id="result-recepcion" class="result"></div>

  <h2>Consultas y Reportes</h2>
  <button class="btn-outline" onclick="consultar('pedidos')">Consultar Pedidos</button>
  <button class="btn-outline" onclick="consultar('produccion')">Consultar Producci칩n</button>
  <button class="btn-outline" onclick="consultar('despacho')">Consultar Despachos</button>
  <button class="btn-outline" onclick="consultar('recepcion')">Consultar Recepciones</button>
  <button class="btn-outline" onclick="consultar('alertas')">Ver Alertas</button>
  <div class="endpoint">GET /pedidos, /produccion, /despacho, /recepcion, /alertas</div>
  <div id="result-consultas" class="result"></div>

  <h2>Trazabilidad</h2>
  <form id="form-traza">
    <label>Lote 
      <select class="select w-[180px]" name="lote" id="select-lote-traza">
        <option value="">-- Seleccionar lote --</option>
      </select>
    </label>
    <button class="btn" type="submit">Consultar Trazabilidad</button>
    <div class="endpoint">GET /traza/lote/{lote_id}</div>
  </form>
  <div id="result-traza" class="result"></div>

  <h2>Gesti칩n de Datos Maestros</h2>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2em; margin-top: 1em;">
    
    <div>
      <h3>Productos</h3>
      <form id="form-producto">
        <div class="grid gap-3">
            <label class="label">Nombre del Producto</label>
            <input class="input" type="text" name="nombre" required placeholder="Ej: Pan Integral">
        </div>
        <button class="btn" type="submit">Agregar Producto</button>
        <div class="endpoint">POST /maestros/producto</div>
      </form>
      <div id="result-producto" class="result"></div>
    </div>

    <div>
      <h3>Empleados</h3>
      <form id="form-empleado-maestro">
        <div class="grid gap-3">
            <label class="label">DNI</label>
            <input class="input" type="text" name="dni" pattern="[0-9]{7,8}" title="Solo n칰meros, 7-8 d칤gitos" required placeholder="12345678">
        </div>
        <div class="grid gap-3">
          <label class="label">Nombre del Empleado</label>
          <input class="input" type="text" name="nombre" required placeholder="Ej: Juan P칠rez">
        </div>
        <button class="btn" type="submit">Agregar Empleado</button>
        <div class="endpoint">POST /maestros/empleado</div>
      </form>
      <div id="result-empleado-maestro" class="result"></div>
    </div>

    <div>
      <h3>Tiendas</h3>
      <form id="form-tienda-maestro">
        <div class="grid gap-3">
          <label class="label">Nombre de la Tienda</label>
          <input class="input" type="text" name="nombre" required placeholder="Ej: Sucursal Norte">
        </div>
        <button class="btn" type="submit">Agregar Tienda</button>
        <div class="endpoint">POST /maestros/tienda</div>
      </form>
      <div id="result-tienda-maestro" class="result"></div>
    </div>

  </div>

  <h2>Datos Maestros Registrados</h2>
  <div style="margin-top: 1em;">
    <button class="btn-outline" onclick="verMaestros('all')">游늶 Ver Todos</button>
    <button class="btn-outline" onclick="verMaestros('producto')">游닍 Productos</button>
    <button class="btn-outline" onclick="verMaestros('empleado')">游논 Empleados</button>
    <button class="btn-outline" onclick="verMaestros('tienda')">游낅 Tiendas</button>
    <div class="endpoint">GET /maestros</div>
  </div>
  <div id="result-maestros-list" class="result"></div>

  <h2>Administraci칩n de Roles</h2>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2em; margin-top: 1em;">
    
    <!-- Gesti칩n de Roles -->
    <div>
      <h3>Gesti칩n de Roles</h3>
      
      <!-- Crear nuevo rol -->
      <form id="form-nuevo-rol">
        <div class="grid gap-3">
          <label class="label">Nombre del Rol</label>
          <input class="input" type="text" name="nombre" required>
        </div>
        <div class="grid gap-3">
          <label class="label">Descripci칩n</label>
          <input class="input" type="text" name="descripcion" required>
        </div>
        <button class="btn" type="submit">Crear Rol</button>
        <div class="endpoint">POST /roles</div>
      </form>
      <div id="result-nuevo-rol" class="result"></div>
      
      <!-- Listar roles -->
      <div style="margin-top: 2em;">
        <button class="btn-outline" onclick="listarRoles()">Ver Roles</button>
        <div class="endpoint">GET /roles</div>
      </div>
      <div id="result-roles" class="result"></div>
    </div>
    
    <!-- Gesti칩n de Permisos -->
    <div>
      <h3>Gesti칩n de Permisos</h3>
      
      <!-- Crear nuevo permiso -->
      <form id="form-nuevo-permiso">
        <div class="grid gap-3">
          <label class="label">Endpoint</label>
          <input class="input" type="text" name="endpoint" placeholder="/nuevo-endpoint" required>
        </div>
        <div class="grid gap-3">
          <label class="label">M칠todo</label>
          <select class="select" name="metodo">
            <option value="*">Todos (*)</option>
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
          </select>
        </label>
        <div class="grid gap-3">
          <label class="label">Descripci칩n</label>
          <input class="input" type="text" name="descripcion" required>
        </div>
        <button class="btn" type="submit">Crear Permiso</button>
        <div class="endpoint">POST /permisos</div>
      </form>
      <div id="result-nuevo-permiso" class="result"></div>
      
      <!-- Listar permisos -->
      <div style="margin-top: 2em;">
        <button class="btn-outline" onclick="listarPermisos()">Ver Permisos</button>
        <div class="endpoint">GET /permisos</div>
      </div>
      <div id="result-permisos" class="result"></div>
    </div>
  </div>
  
  <!-- Asignaci칩n de Permisos a Roles -->
  <div style="margin-top: 2em;">
    <h3>Asignar Permisos a Roles</h3>
    <form id="form-asignar-permisos">
      <div class="form-row">
        <div class="grid gap-3">
          <label class="label">Rol</label>
          <select id="select-rol-permisos" class="select" name="rol_id" required></select>
        </div>
        <button class="btn-outline" type="button" onclick="cargarPermisosDelRol()">Ver Permisos Actuales</button>
      </div>
      
      <div id="permisos-disponibles" style="margin-top: 1em; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 1em; background: #f9f9f9;">
        <p>Selecciona un rol para ver los permisos disponibles</p>
      </div>
      
      <button class="btn" type="submit">Asignar Permisos Seleccionados</button>
      <div class="endpoint">POST /roles/{id}/permisos</div>
    </form>
    <div id="result-asignar-permisos" class="result"></div>
  </div>
  
  <!-- Verificador de Permisos -->
  <div style="margin-top: 2em;">
    <h3>Verificar Permisos</h3>
    <form id="form-verificar-permiso">
      <div class="form-row">
        <div class="grid gap-3">
          <label class="label">Rol</label>
          <input class="input" type="text" name="rol_nombre" placeholder="admin" required>
        </div>
        <div class="grid gap-3">
          <label class="label">Endpoint</label>
          <input class="input" type="text" name="endpoint" placeholder="/pedidos" required>
        </div>
        <div class="grid gap-3">
          <label class="label">M칠todo</label>
          <select class="select" name="metodo">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
          </select>
        </label>
        <button class="btn" type="submit">Verificar</button>
      </div>
      <!-- <div class="endpoint">GET /roles/{nombre}/permiso</div> -->
    </form>
    <div id="result-verificar-permiso" class="result"></div>
  </div>

  <h2>Gesti칩n de Usuarios</h2>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2em; margin-top: 1em;">
    
    <!-- Crear Usuario -->
    <div>
      <h3>Crear Usuario</h3>
      <form id="form-nuevo-usuario">
        <div class="grid gap-3">
          <label class="label">Empleado</label>
          <select class="select" name="empleado_id" id="select-empleado-usuario" required>
            <option value="">-- Seleccionar empleado --</option>
          </select>
        </div>
        <div class="grid gap-3">
          <label class="label">Password</label>
          <input class="input" type="password" name="password" required>
        </div>
        <div class="grid gap-3">
          <label class="label">Rol</label>
          <select class="select" name="rol_id" id="select-rol-usuario" required onchange="mostrarCampoTienda()">
            <option value="">-- Seleccionar rol --</option>
          </select>
        </div> 

        <div id="campo-tienda-usuario" style="display: none;">
          <label class="label">Tienda</label>
          <select name="tienda_id" id="select-tienda-usuario">
            <option value="">-- Seleccionar tienda --</option>
          </select>
          <p style="color: #dc3545; font-size: 0.9em; margin-top: 0.3em;">
            丘멆잺 El usuario solo tendr치 acceso a la tienda seleccionada
          </p>
        </div>
        <p style="color: #666; font-size: 0.9em; margin-top: 0.5em;">
          El usuario se crea para el empleado seleccionado. El DNI y nombre se toman del empleado.
        </p>
        <button class="btn" type="submit">Crear Usuario</button>
        <div class="endpoint">POST /usuarios</div>
      </form>
      <div id="result-nuevo-usuario" class="result"></div>
    </div>
    
    <!-- Listar Usuarios -->
    <div>
      <h3>Usuarios Registrados</h3>
      <button class="btn-outline" onclick="listarUsuarios()">Ver Usuarios</button>
      <div class="endpoint">GET /usuarios</div>
      <div id="result-usuarios" class="result"></div>
    </div>
  </div>
  
  <!-- Editar Usuario -->
  <div style="margin-top: 2em;">
    <h3>Editar Usuario</h3>
    <form id="form-editar-usuario" style="display: none;">
      <input type="hidden" name="id">
      <div class="grid gap-3">
        <label class="label">Empleado </label>
          <select class="select" name="empleado_id" id="select-empleado-editar" required>
            <option value="">-- Seleccionar empleado --</option>
          </select>
        <div class="grid gap-3">
        <label class="label">Nuevo Password (opcional)</label>
        <input class="input" type="password" name="password" placeholder="Dejar vac칤o para mantener el actual">
        </div>
      </div>
      <div class="grid gap-3">
        <label class="label">Rol </label>
          <select class="select" name="rol_id" id="select-rol-editar" required onchange="mostrarCampoTiendaEditar()">
            <option value="">-- Seleccionar rol --</option>
          </select>
        </div>
        <div class="grid gap-3">
          <label class="label">Estado </label>
          <select class="select" name="activo" required>
            <option value="1">Activo</option>
            <option value="0">Inactivo</option>
          </select>
        </div>
      <div id="campo-tienda-usuario-editar" style="display: none; margin-top: 0.5em;">
        <label>Tienda 
          <select name="tienda_id" id="select-tienda-editar">
            <option value="">-- Seleccionar tienda --</option>
          </select>
        </label>
        <p style="color: #dc3545; font-size: 0.9em; margin-top: 0.3em;">
          丘멆잺 El usuario solo tendr치 acceso a la tienda seleccionada
        </p>
      </div>
      <div class="form-row">
        <button class="btn-secondary" type="button" onclick="cancelarEdicionUsuario()">Cancelar</button>
        <button class="btn" type="submit">Actualizar Usuario</button>
      </div>
      <div class="endpoint">PUT /usuarios/{id}</div>
    </form>
    <div id="result-editar-usuario" class="result"></div>
  </div>

  <!-- Scripts -->
  <script src="assets/js/main.js"></script>
  <script src="assets/js/forms.js"></script>
  <script src="assets/js/lotes.js"></script>
  <script src="assets/js/pedidos.js"></script>
  <script src="assets/js/workflow.js"></script>
  <script src="assets/js/events.js"></script>
  <script src="assets/js/maestros.js"></script>
  <script src="assets/js/roles.js"></script>
  <script src="assets/js/usuarios.js"></script>
  
  <!-- Sistema de autenticaci칩n -->
  <script>
    let currentUser = null;
    
    // Verificar autenticaci칩n al cargar la p치gina
    async function checkAuth() {
      try {
        const response = await fetch('/session');
        if (!response.ok) {
          window.location.href = '/login.html';
          return;
        }
        
        const result = await response.json();
        if (!result.authenticated) {
          window.location.href = '/login.html';
          return;
        }
        
        // Usuario autenticado
        currentUser = result.usuario;
        updateUserInfo();
        
      } catch (error) {
        console.error('Error verificando autenticaci칩n:', error);
        window.location.href = '/login.html';
      }
    }
    
    // Actualizar informaci칩n del usuario en el header
    function updateUserInfo() {
      const userInfo = document.getElementById('user-info');
      if (currentUser) {
        userInfo.textContent = `${currentUser.nombre} (${currentUser.rol})`;
        
        // Establecer autom치ticamente el nombre del empleado en todos los formularios
        if (currentUser.nombre) {
          // Establecer el valor en los campos ocultos de empleado
          document.querySelectorAll('[id^="select-empleado"]').forEach(select => {
            console.log(`Actualizando campo empleado: ${select.id} con valor ${currentUser.nombre}`);
            select.value = currentUser.nombre;
          });
          
          // Establecer expl칤citamente el valor del campo oculto de producci칩n
          if (document.getElementById('select-empleado')) {
            document.getElementById('select-empleado').value = currentUser.nombre;
            console.log(`Campo select-empleado actualizado con: ${currentUser.nombre}`);
          }
        }
      }
    }
    
    // Funci칩n de logout
    async function logout() {
      try {
        await fetch('/logout', { method: 'POST' });
      } catch (error) {
        console.error('Error en logout:', error);
      } finally {
        window.location.href = '/login.html';
      }
    }
    
    // Verificar autenticaci칩n al cargar
    checkAuth();
  </script>
</body>
</html>
